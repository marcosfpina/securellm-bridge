# .gitlab-ci.yml
# Cerebro GitLab CI/CD Pipeline
# Triggers on: push to main, merge requests, manual trigger

stages:
  - validate
  - test
  - build
  - deploy
  - monitor

variables:
  DOCKER_IMAGE: "python:3.13-slim"
  GCP_REGION: "us-central1"
  GCP_PROJECT_ID: "gen-lang-client-0530325234"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  POETRY_VIRTUALENVS_CREATE: "true"

# ============================================================================
# STAGE 1: VALIDATE - Quick syntax and import checks
# ============================================================================

validate:imports:
  stage: validate
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git curl
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install --no-root
    - poetry run python -c "from phantom.core import gcp"
    - poetry run python -c "from phantom.modules import credit_burner"
    - poetry run python -c "import typer; import rich"
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

validate:syntax:
  stage: validate
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install --no-root
    - find src/phantom/ -name "*.py" -exec python -m py_compile {} \;
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

# ============================================================================
# STAGE 2: TEST - Unit tests, integration tests, linting
# ============================================================================

test:unit:
  stage: test
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run pytest tests/ -v --ignore=tests/integration --cov=src/phantom --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 30 days
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

test:integration:
  stage: test
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run pytest tests/integration/ -v -m integration --tb=short
  cache:
    paths:
      - .venv/
      - .cache/pip/
  allow_failure: true
  only:
    - main
    - merge_requests

test:lint:
  stage: test
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run ruff check src/ tests/
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

test:format:
  stage: test
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run ruff format --check src/ tests/
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

test:cli:
  stage: test
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run cerebro --help
    - poetry run cerebro info
    - poetry run cerebro version
    - poetry run cerebro ops status
  cache:
    paths:
      - .venv/
      - .cache/pip/
  only:
    - main
    - merge_requests

# ============================================================================
# STAGE 3: BUILD - Build Docker image and push to registry
# ============================================================================

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
  when: manual

# ============================================================================
# STAGE 4: DEPLOY - Deploy to Cloud Run
# ============================================================================

deploy:cloud-run:
  stage: deploy
  image: google/cloud-sdk:alpine
  script:
    # Authenticate with GCP using service account key
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > ${HOME}/gcp-key.json
    - gcloud auth activate-service-account --key-file ${HOME}/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    
    # Deploy to Cloud Run
    - gcloud run deploy cerebro-api
        --source .
        --region $GCP_REGION
        --platform managed
        --allow-unauthenticated
        --set-env-vars "GCP_PROJECT_ID=$GCP_PROJECT_ID,DATA_STORE_ID=$DATA_STORE_ID"
        --memory 2Gi
        --timeout 3600
  environment:
    name: production
    url: https://cerebro-api-$GCP_REGION.a.run.app
  only:
    - main
  when: manual

# ============================================================================
# STAGE 5: MONITOR - Health checks and reporting
# ============================================================================

monitor:health:
  stage: monitor
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git curl
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install
    - poetry run cerebro ops health
  cache:
    paths:
      - .venv/
      - .cache/pip/
  allow_failure: true
  only:
    - main

# ============================================================================
# MERGE REQUEST PIPELINE - Lightweight checks for PRs
# ============================================================================

.mr_only: &mr_only
  only:
    - merge_requests

mr:quick-check:
  <<: *mr_only
  stage: validate
  image: ${DOCKER_IMAGE}
  script:
    - apt-get update && apt-get install -y git
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - poetry install --no-root
    - poetry run ruff check src/ tests/ --select E,F,W
  cache:
    paths:
      - .venv/
      - .cache/pip/
